= Filter Messages into a New Topic using a Regex
:page-layout: lab
:env-docker: true
:page-categories: Development, Stream Processing, Data Transforms
:description: Filter messages from one topic into another using regular expressions (regex) and data transforms.
// Set up attributes to hold the latest version of Redpanda and Redpanda Console.
// For GitHub, hard-code the latest version to these values:
ifndef::env-site[]
:latest-redpanda-version: 23.3.5
:latest-console-version: 2.4.0
endif::[]
// For the docs site, use the built-in attributes that store the latest version as fetched from GitHub releases.
ifdef::env-site[]
:latest-redpanda-version: {full-version}
// All pages already have access to {latest-console-version} on the docs site.
endif::[]

This is an example of how to filter messages from one topic into another using regular expressions (regex) and Redpanda data transforms.

Regexes are implemented using Go's `regexp` library, which uses the same syntax as RE2.
See the https://github.com/google/re2/wiki/Syntax[RE2 wiki] for help with syntax.

== Prerequisites

You must have the following:

- At least version 1.20 of https://go.dev/doc/install[Go^] installed on your host machine.
- The link:https://docs.redpanda.com/current/get-started/rpk-install/[`rpk` command-line client].
+
Install `rpk` on your host machine and configure it to connect to your Redpanda cluster.
- https://docs.docker.com/compose/install/[Docker and Docker Compose] installed on your host machine.

== Run the lab

. Clone this repository:
+
```bash
git clone https://github.com/redpanda-data/redpanda-labs.git
```

. Change into the `data-transforms/regex/` directory:
+
[,bash]
----
cd redpanda-labs/data-transforms/regex
----

. Set the `REDPANDA_VERSION` environment variable to at least version 23.3.1. Data transforms was introduced in this version. For all available versions, see the https://github.com/redpanda-data/redpanda/releases[GitHub releases].
+
For example:
+
[,bash,subs="attributes+"]
----
export REDPANDA_VERSION={latest-redpanda-version}
----

. Set the `REDPANDA_CONSOLE_VERSION` environment variable to the version of Redpanda Console that you want to run. For all available versions, see the https://github.com/redpanda-data/redpanda/releases[GitHub releases].
+
For example:
+
[,bash,subs="attributes+"]
----
export REDPANDA_CONSOLE_VERSION={latest-console-version}
----

. Start Redpanda in Docker by running the following command:
+
```bash
docker compose up -d
```

. Set up your rpk profile:
+
```bash
docker exec -it redpanda-0 rpk profile create regex --from-profile profile.yml
```

. Create the required topics:
+
```bash
docker exec -it redpanda-0 rpk topic create src sink
```

. Deploy the transforms function:
+

```bash
docker exec -it redpanda-0 rpk transform build
docker exec -it redpanda-0 rpk transform deploy --var=PATTERN=myregex --input-topic=src --output-topic=sink
```
+
This example accepts the following environment variables:
+
- `PATTERN` (*required*): The regex to match against records.
- `MATCH_VALUE`: By default, the regex matches record keys, but if set to `true`, the regex will match values.

== Clean up

To shut down and delete the containers along with all your cluster data:

```bash
docker compose down -v
```
